<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>API Reference</title>

    <style>
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight, .highlight .w {
  color: #f8f8f2;
  background-color: #272822;
}
.highlight .err {
  color: #151515;
  background-color: #ac4142;
}
.highlight .c, .highlight .cd, .highlight .cm, .highlight .c1, .highlight .cs {
  color: #505050;
}
.highlight .cp {
  color: #f4bf75;
}
.highlight .nt {
  color: #f4bf75;
}
.highlight .o, .highlight .ow {
  color: #d0d0d0;
}
.highlight .p, .highlight .pi {
  color: #d0d0d0;
}
.highlight .gi {
  color: #90a959;
}
.highlight .gd {
  color: #ac4142;
}
.highlight .gh {
  color: #6a9fb5;
  background-color: #151515;
  font-weight: bold;
}
.highlight .k, .highlight .kn, .highlight .kp, .highlight .kr, .highlight .kv {
  color: #aa759f;
}
.highlight .kc {
  color: #d28445;
}
.highlight .kt {
  color: #d28445;
}
.highlight .kd {
  color: #d28445;
}
.highlight .s, .highlight .sb, .highlight .sc, .highlight .sd, .highlight .s2, .highlight .sh, .highlight .sx, .highlight .s1 {
  color: #90a959;
}
.highlight .sr {
  color: #75b5aa;
}
.highlight .si {
  color: #8f5536;
}
.highlight .se {
  color: #8f5536;
}
.highlight .nn {
  color: #f4bf75;
}
.highlight .nc {
  color: #f4bf75;
}
.highlight .no {
  color: #f4bf75;
}
.highlight .na {
  color: #6a9fb5;
}
.highlight .m, .highlight .mf, .highlight .mh, .highlight .mi, .highlight .il, .highlight .mo, .highlight .mb, .highlight .mx {
  color: #90a959;
}
.highlight .ss {
  color: #90a959;
}
    </style>
    <link href="stylesheets/screen.css" rel="stylesheet" media="screen" />
    <link href="stylesheets/print.css" rel="stylesheet" media="print" />
      <script src="javascripts/all.js"></script>
  </head>

  <body class="index" data-languages="[&quot;php&quot;,&quot;cs&quot;]">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar.png" />
      </span>
    </a>
    <div class="tocify-wrapper">
      <img src="images/logo.png" />
        <div class="lang-selector">
              <a href="#" data-language-name="php">PHP</a>
              <a href="#" data-language-name="cs">C#</a>
        </div>
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <div id="toc">
      </div>
        <ul class="toc-footer">
            <li><a href='https://mandarinbank.com'>MandarinBank</a></li>
            <li><a href='https://github.com/MandarinPay'>MandarinBank на GitHub</a></li>
        </ul>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        <h1 id="introduction">Introduction</h1>

<aside class="warning">
Убедитесь, пожалуйста, что вы внимательно ознакомились с данными пунктами. Возможно, ответ на ваш вопрос содержится здесь.
</aside>

<ul>
<li><p>Во всех запросах и ответах следует использовать кодировку UTF8</p></li>
<li><p>Для работы вам потребуется получить номер мерчанта (<code class="prettyprint">merchantId</code>), доступный в клиентском интерфейсе, а так же сгенерировать и задать секретный ключ (<code class="prettyprint">sharedsec</code>), что так же можно сделать из клиентского интерфейса. Обратите внимание, что <strong>секретный ключ ни в каком виде не должен покидать вашего сервера</strong>. В случае если он передаётся как часть HTML или каким-либо образом используется в JavaScript, это является <strong>проблемой безопасности</strong> и даёт злоумышленнику возможность делать вызовы к платёжной системе от вашего имени.</p></li>
<li><p>Для корректной обработки транзакций вам необходимо реализовать обработчики двух URL - один для возвращения пользователя на ваш сайт, другой для приёма уведомлений (<code class="prettyprint">webhook</code>/<code class="prettyprint">callback</code>) о состоянии транзакций, их можно задать на вкладке &ldquo;Интеграция&rdquo; клиентского интерфейса.</p></li>
<li><p>Данные тестовых карт для проверки работоспособности в sandbox-режиме</p></li>
</ul>

<table><thead>
<tr>
<th>Параметр</th>
<th>Значение</th>
<th>Комментарий</th>
</tr>
</thead><tbody>
<tr>
<td>Имя держателя карты</td>
<td>CARD HOLDER</td>
<td></td>
</tr>
<tr>
<td>CVV</td>
<td>123</td>
<td></td>
</tr>
<tr>
<td>Номер карты</td>
<td>4929509947106878</td>
<td>Для успешных</td>
</tr>
<tr>
<td>Номер карты</td>
<td>4485913187374384</td>
<td>Для неуспешных</td>
</tr>
</tbody></table>

<ul>
<li>Примеры приложения для работы с API на PHP находятся на <a href="https://github.com/MandarinPay">GitHub</a>:</li>
</ul>

<table><thead>
<tr>
<th>Название</th>
<th>Описание</th>
<th>Cсылка</th>
</tr>
</thead><tbody>
<tr>
<td>Приложение платежного шлюза</td>
<td>Приложение позволяет ознакомиться с основными принципами и методами работы платежного API</td>
<td><a href="https://github.com/MandarinPay/php-example">GitHub</a></td>
</tr>
<tr>
<td><code class="prettyprint">Callback</code> модуль платежного шлюза</td>
<td>Данный модуль может перехватывать <code class="prettyprint">Callback</code> вызовы, складывать из в БД, а так же отправлять email потранзакционно/реестром о совершенных операциях. Имеет API для запроса реестров из БД</td>
<td><a href="https://github.com/MandarinPay/MandarinCallback_module">GitHub</a></td>
</tr>
<tr>
<td>Приложение информационного шлюза</td>
<td>Приложение позволяет ознакомиться с основными принципами и методами работы информационного шлюза, в т.ч. упрощенной идентификации</td>
<td><a href="https://github.com/MandarinPay/MandarinInfo_module">GitHub</a></td>
</tr>
</tbody></table>

<h1 id="api">API платежных форм</h1>

<p>Перечень и описание возможных полей приведены в таблице.</p>

<table><thead>
<tr>
<th>Поле</th>
<th>Обяз-ть</th>
<th>Описание</th>
</tr>
</thead><tbody>
<tr>
<td>merchantId</td>
<td>Да</td>
<td>Id мерчанта</td>
</tr>
<tr>
<td>price</td>
<td>Да</td>
<td>Сумма платежа. Обязательна к передаче в текущей версии системы.</td>
</tr>
<tr>
<td>orderId</td>
<td>Да</td>
<td>Уникальный номер заказа в системе Продавца.</td>
</tr>
<tr>
<td>customer_email</td>
<td>Да</td>
<td>Email пользователя</td>
</tr>
<tr>
<td>sign</td>
<td>Да</td>
<td>Контрольная подпись данных о платеже. Методику подсчёта см. ниже</td>
</tr>
<tr>
<td>customValue1</td>
<td>Нет</td>
<td>Дополнительные параметры, которые могут использоваться для прикрепления дополнительной информации к данным Платежа и Плательщика. При использовании совместно с customName данные будут отображаться на платежной странице. Не передаются в <code class="prettyprint">Callback</code></td>
</tr>
<tr>
<td>customValue2</td>
<td>Нет</td>
<td>См. выше</td>
</tr>
<tr>
<td>customValue3</td>
<td>Нет</td>
<td>См. выше</td>
</tr>
<tr>
<td>customName1</td>
<td>Нет</td>
<td>Используется совместно с customValue для отображения передаваемой информации Плательщику на платежной странице.</td>
</tr>
<tr>
<td>customName2</td>
<td>Нет</td>
<td>См. выше</td>
</tr>
<tr>
<td>customName3</td>
<td>Нет</td>
<td>См. выше</td>
</tr>
<tr>
<td>extra_*</td>
<td>Нет</td>
<td>Данные поля используются в случае, если необходимо передать дополнительную информацию в <code class="prettyprint">Callback</code> о результате платежа и не видны Плательщику. Должны иметь вид <code class="prettyprint">extra_[A-Za-z0-9_]+</code></td>
</tr>
<tr>
<td>customer_phone</td>
<td>Нет</td>
<td>Телефон пользователя в формате +XXXXXXXXXXX (обязателен для привязки карты)</td>
</tr>
</tbody></table>

<h2 id="payment-page">Payment page (платежная страница)</h2>
<pre class="highlight html"><code><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"https://secure.mandarinpay.com/Pay"</span> <span class="na">method=</span><span class="s">"POST"</span><span class="nt">&gt;</span> 
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"merchantId"</span> <span class="na">value=</span><span class="s">"812"</span> <span class="nt">/&gt;</span>  
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"price"</span> <span class="na">value=</span><span class="s">"12.34"</span> <span class="nt">/&gt;</span> 
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"orderId"</span> <span class="na">value=</span><span class="s">"325GVD"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"customer_email"</span> <span class="na">value=</span><span class="s">"test@test.com"</span> <span class="nt">/&gt;</span> 
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"customValue1"</span> <span class="na">value=</span><span class="s">"client value 1"</span> <span class="nt">/&gt;</span> 
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"customName1"</span> <span class="na">value=</span><span class="s">"client name 1"</span> <span class="nt">/&gt;</span> 
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"customValue2"</span> <span class="na">value=</span><span class="s">"client value 2"</span> <span class="nt">/&gt;</span>  
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"sign"</span> <span class="na">value=</span><span class="s">"d41d8cd98f00b204e9800998ecf8427e"</span> <span class="nt">/&gt;</span> 
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Оплатить"</span> <span class="nt">/&gt;</span> 
<span class="nt">&lt;/form&gt;</span>
</code></pre>

<p><code class="prettyprint">POST</code> запрос на адрес <code class="prettyprint">https://secure.mandarinpay.com/Pay</code></p>

<p>Необходимо сгенерировать форму.</p>

<h2 id="payment-widget">Payment Widget (платежный виджет)</h2>

<blockquote>
<p>Скрипт</p>
</blockquote>
<pre class="highlight html"><code><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://secure.mandarinpay.com/api/widget.js"</span> <span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;&lt;/script&gt;</span>
</code></pre>

<blockquote>
<p>Форма</p>
</blockquote>
<pre class="highlight html"><code><span class="nt">&lt;form</span> <span class="na">onsubmit=</span><span class="s">"return false;"</span><span class="nt">&gt;</span> 
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"merchantId"</span> <span class="na">value=</span><span class="s">"812"</span> <span class="nt">/&gt;</span>  
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"price"</span> <span class="na">value=</span><span class="s">"12.34"</span> <span class="nt">/&gt;</span> 
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"orderId"</span> <span class="na">value=</span><span class="s">"325GVD"</span> <span class="nt">/&gt;</span> 
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"customValue1"</span> <span class="na">value=</span><span class="s">"client value 1"</span> <span class="nt">/&gt;</span> 
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"customValue2"</span> <span class="na">value=</span><span class="s">"client value 2"</span> <span class="nt">/&gt;</span>  
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"customValue3"</span> <span class="na">value=</span><span class="s">"client value 3"</span> <span class="nt">/&gt;</span> 
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"sign"</span> <span class="na">value=</span><span class="s">"d41d8cd98f00b204e9800998ecf8427e"</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span> <span class="na">onclick=</span><span class="s">"return mandarin.payForm(this);"</span><span class="nt">&gt;</span>Оплатить<span class="nt">&lt;/a&gt;</span>

<span class="nt">&lt;/form&gt;</span>
</code></pre>

<p>Виджет оплаты представляет из себя pop-up открывающийся в <code class="prettyprint">iframe</code> на стороне Продавца. Последующее открытие страницы с 3DS также происходит в <code class="prettyprint">iframe</code></p>

<p>Для использования виджета необходимо подключить скрипт, после чего использовать <code class="prettyprint">mandarin.payForm(&quot;#id_формы&quot;);</code> для показа виджета с оплатой. Форма генерируется тем же способом, что и при работе с API платежной страницы.</p>

<p>Так же можно использовать <code class="prettyprint">onclick=&quot;return mandarin.payForm(this);&quot;</code> в качестве обработчика ссылок и кнопок внутри формы оплаты.</p>

<h2 id="binding-widget">Binding Widget (привязка через виджет)</h2>
<pre class="highlight html"><code><span class="nt">&lt;form</span> <span class="na">onsubmit=</span><span class="s">"return false;"</span><span class="nt">&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"merchantId"</span> <span class="na">value=</span><span class="s">"812"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"orderId"</span> <span class="na">value=</span><span class="s">"325GVD"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">'customer_phone'</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">'+71234567890'</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">'customer_email'</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">'user@example.com'</span><span class="nt">/&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"sign"</span> <span class="na">value=</span><span class="s">"d41d8cd98f00b204e9800998ecf8427e"</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span> <span class="na">onclick=</span><span class="s">"return mandarin.bindCardForm(this);"</span><span class="nt">&gt;</span>Привязать<span class="nt">&lt;/a&gt;</span>

<span class="nt">&lt;/form&gt;</span>
</code></pre>

<p>Для привязки карты через виджет вам необходимо на своём сайте сгенерировать форму.</p>

<p>Назначение параметров соответствует параметрам из API платежной страницы. Так же можно использовать <code class="prettyprint">mandarin.bindCardForm(&quot;#id&quot;);</code></p>

<p>Поля <code class="prettyprint">customer_phone</code> и <code class="prettyprint">customer_email</code> являются обязательными для привязки карты</p>

<h2 id="custom-form-embed-api">Custom form (embed API)</h2>

<blockquote>
<p>Скрипт</p>
</blockquote>
<pre class="highlight html"><code><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://secure.mandarinpay.com/api/embed.js"</span> <span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;&lt;/script&gt;</span>
</code></pre>
<pre class="highlight html"><code>onsuccess:
</code></pre>
<pre class="highlight javascript"><code><span class="p">{</span>
  <span class="nl">transaction</span><span class="p">:</span>
  <span class="p">{</span>
    <span class="nl">id</span><span class="p">:</span> <span class="s2">"c8a42608-ac02-449d-aae4-265778df5e27"</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<pre class="highlight html"><code>onerror:
</code></pre>
<pre class="highlight javascript"><code><span class="p">{</span>
  <span class="nl">error</span><span class="p">:</span> <span class="s2">"Текст ошибки"</span>
<span class="p">}</span>
</code></pre>

<blockquote>
<p>Форма для совешения платежа</p>
</blockquote>
<pre class="highlight html"><code><span class="nt">&lt;form</span> <span class="na">id=</span><span class="s">"form-pay"</span><span class="nt">&gt;</span>
  <span class="c">&lt;!--Генерируется на сервере--&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"price"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"12.34"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"orderId"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"123321"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"merchantId"</span> <span class="na">value=</span><span class="s">"1"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"sign"</span> <span class="na">value=</span><span class="s">"testing"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">'customer_phone'</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">'+71234567890'</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">'customer_email'</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">'user@example.com'</span> <span class="nt">/&gt;</span>

    <span class="c">&lt;!--Заполняется пользователем--&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">data-pay-name=</span><span class="s">"CardNumber"</span> <span class="nt">/&gt;&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">data-pay-name=</span><span class="s">"CardHolder"</span> <span class="na">value=</span><span class="s">"CARD HOLDER"</span> <span class="nt">/&gt;&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">data-pay-name=</span><span class="s">"CardExpireYear"</span> <span class="na">value=</span><span class="s">"20"</span> <span class="nt">/&gt;&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">data-pay-name=</span><span class="s">"CardExpireMonth"</span> <span class="na">value=</span><span class="s">"12"</span> <span class="nt">/&gt;&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">data-pay-name=</span><span class="s">"Cvv"</span> <span class="na">value=</span><span class="s">"123"</span> <span class="nt">/&gt;&lt;br</span> <span class="nt">/&gt;</span>

     <span class="c">&lt;!--Обработчик оплаты и ответа на неё--&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span> <span class="na">onclick=</span><span class="s">"return mandarinpay.embed.pay(this, function (data) { alert('Success. Transaction id is ' + data.transaction.id); }, function (error) { alert('error: ' + error.error); });"</span> <span class="na">class=</span><span class="s">"btn btn-default"</span><span class="nt">&gt;</span>
        Pay
    <span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</code></pre>

<aside class="notice">
Данная форма доступна для использования только по предварительному согласованию. Обратитесь к вашему менеджеру.
</aside>

<p>Для использования API внедрённых форм необходимо подключить скрипт, после чего из JS доступны для вызова функции <code class="prettyprint">mandarinpay.embed.pay(selector, onsuccess, onerror)</code> и <code class="prettyprint">mandarinpay.embed.bindCard(selector, onsuccess, onerror)</code></p>

<p><code class="prettyprint">selector</code> - jQuery-совместимый селектор, указывающий на форму или HTML-элемент внутри формы либо сама форма (<code class="prettyprint">this</code> из вызова <code class="prettyprint">onclick</code> на элементе подойдёт)</p>

<p><code class="prettyprint">onsuccess</code> и <code class="prettyprint">onerror</code> - функции обратного вызова</p>

<p>Форма состоит из двух частей:</p>

<ul>
<li>Сгенерированные у вас на сервере поля с <code class="prettyprint">type=&quot;hidden&quot;</code> с информацией о транзакции или привязке карты (подробности генерации см. в документации по API платежной страницы). </li>
</ul>

<aside class="notice">
Напоминаем, что поле sign обязательно должно генерироваться на стороне сервера, а ключ мерчанта не должен попадать в JavaScript-часть.
</aside>

<ul>
<li>Видимые пользователю или доступные для изменения другим образом поля с карточными данными. <strong>Обратите внимание, что в полях отсутствует атрибут</strong> <code class="prettyprint">name</code>, что позволяет не сохранять карточные данные на вашем сервере. Вместо этого они идентифицируются атрибутом <code class="prettyprint">data-pay-name</code>. </li>
</ul>

<aside class="warning">
В случае обнаружения атрибут NAME при работе по данной схеме Продацец будет незамедлительно отключен от системы
</aside>

<p>В случае с привязкой карты вместо <code class="prettyprint">mandarinpay.embed.pay</code> следует вызывать <code class="prettyprint">mandarinpay.embed.bindCard</code>.</p>

<p>Следует обратить внимание, что форма является одноразовой, после попытки совершить платёж в ней будет сохранён id операции и повторные попытки вызова <code class="prettyprint">mandarinpay.embed.pay</code> не будут приводить к созданию новой. Вы можете безопасно повторять вызовы в рамках одной операции.</p>

<h2 id="sign">Подсчёт поля sign</h2>

<blockquote>
<p>Пример генерации поля <code class="prettyprint">sign</code> и формирования формы</p>
</blockquote>
<pre class="highlight php"><code><span class="cp">&lt;?php</span>
<span class="k">function</span> <span class="nf">calc_sign</span><span class="p">(</span><span class="nv">$secret</span><span class="p">,</span> <span class="nv">$fields</span><span class="p">)</span>
<span class="p">{</span>
        <span class="nb">ksort</span><span class="p">(</span><span class="nv">$fields</span><span class="p">);</span>
        <span class="nv">$secret_t</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
        <span class="k">foreach</span><span class="p">(</span><span class="nv">$fields</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$val</span><span class="p">)</span>
        <span class="p">{</span>
                <span class="nv">$secret_t</span> <span class="o">=</span> <span class="nv">$secret_t</span> <span class="o">.</span> <span class="s1">'-'</span> <span class="o">.</span> <span class="nv">$val</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$secret_t</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$secret_t</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'-'</span> <span class="o">.</span> <span class="nv">$secret</span><span class="p">;</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="s2">"sha256"</span><span class="p">,</span> <span class="nv">$secret_t</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">generate_form</span><span class="p">(</span><span class="nv">$secret</span><span class="p">,</span> <span class="nv">$fields</span><span class="p">)</span>
<span class="p">{</span>
        <span class="nv">$sign</span> <span class="o">=</span> <span class="nx">calc_sign</span><span class="p">(</span><span class="nv">$secret</span><span class="p">,</span> <span class="nv">$fields</span><span class="p">);</span>
        <span class="nv">$form</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
        <span class="k">foreach</span><span class="p">(</span><span class="nv">$fields</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$val</span><span class="p">)</span>
        <span class="p">{</span>
                <span class="nv">$form</span> <span class="o">=</span> <span class="nv">$form</span> <span class="o">.</span> <span class="s1">'&lt;input type="hidden" name="'</span><span class="o">.</span><span class="nv">$key</span><span class="o">.</span><span class="s1">'" value="'</span> <span class="o">.</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$val</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'"/&gt;'</span><span class="o">.</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$form</span> <span class="o">=</span> <span class="nv">$form</span> <span class="o">.</span> <span class="s1">'&lt;input type="hidden" name="sign" value="'</span><span class="o">.</span><span class="nv">$sign</span><span class="o">.</span><span class="s1">'"/&gt;'</span><span class="p">;</span>
        <span class="k">return</span> <span class="nv">$form</span><span class="p">;</span>
<span class="p">}</span>

<span class="nv">$f</span> <span class="o">=</span> <span class="nx">generate_form</span><span class="p">(</span><span class="s2">"123"</span><span class="p">,</span> <span class="nv">$values</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
   <span class="s2">"email"</span> <span class="o">=&gt;</span> <span class="s2">"user@example.com"</span><span class="p">,</span>
   <span class="s2">"merchantId"</span> <span class="o">=&gt;</span> <span class="s2">"1"</span><span class="p">,</span>
   <span class="s2">"orderId"</span> <span class="o">=&gt;</span> <span class="s2">"123"</span><span class="p">,</span>
   <span class="s2">"price"</span> <span class="o">=&gt;</span> <span class="s2">"123.00"</span><span class="p">,</span>
<span class="p">));</span>
<span class="k">echo</span> <span class="nv">$f</span><span class="p">;</span>
<span class="cp">?&gt;</span>
</code></pre>
<pre class="highlight csharp"><code><span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">Calculate</span><span class="p">(</span><span class="kt">string</span> <span class="n">secret</span><span class="p">,</span> <span class="n">IDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;</span> <span class="n">values</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">using</span> <span class="p">(</span><span class="n">var</span> <span class="n">sha256</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">Cryptography</span><span class="p">.</span><span class="n">SHA256</span><span class="p">.</span><span class="nf">Create</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">BitConverter</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(</span><span class="n">sha256</span><span class="p">.</span><span class="nf">ComputeHash</span><span class="p">(</span><span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="s">"-"</span><span class="p">,</span> <span class="n">values</span><span class="p">.</span><span class="nf">OrderBy</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Key</span><span class="p">,</span> <span class="n">StringComparer</span><span class="p">.</span><span class="n">Ordinal</span><span class="p">).</span><span class="nf">Select</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Value</span><span class="p">))</span> <span class="p">+</span> <span class="s">"-"</span> <span class="p">+</span> <span class="n">secret</span><span class="p">))).</span><span class="nf">ToLower</span><span class="p">().</span><span class="nf">Replace</span><span class="p">(</span><span class="s">"-"</span><span class="p">,</span> <span class="s">""</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">Calculator</span><span class="p">.</span><span class="nf">Calculate</span><span class="p">(</span><span class="s">"123"</span><span class="p">,</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;</span>
<span class="p">{</span>
   <span class="p">[</span><span class="s">"email"</span><span class="p">]</span> <span class="p">=</span> <span class="s">"user@example.com"</span><span class="p">,</span>
   <span class="p">[</span><span class="s">"merchantId"</span><span class="p">]</span> <span class="p">=</span> <span class="s">"1"</span><span class="p">,</span>
   <span class="p">[</span><span class="s">"orderId"</span><span class="p">]</span> <span class="p">=</span> <span class="s">"123"</span><span class="p">,</span>
   <span class="p">[</span><span class="s">"price"</span><span class="p">]</span> <span class="p">=</span> <span class="s">"123.00"</span><span class="p">,</span>
<span class="p">});</span>
</code></pre>

<p>Контрольная сумма вычисляется <strong>от всех полей, присутствующих в запросе, перечисленных в алфавитном порядке</strong> и sharedsec (уникальный кода, который знает только платёжная система и Продавец) и разделённых символом “-”.</p>

<p>Например: 
<code class="prettyprint">sign = sha256(email + &quot;-&quot; + merchantId + &quot;-&quot; + orderId + &quot;-&quot; +  price + &quot;-&quot; + sharedsec)</code></p>

<aside class="warning">
ВСЕ ПОЛЯ ЗАПРОСА, ПЕРЕЧИСЛЕННЫЕ В АЛФАВИТНОМ ПОРЯДКЕ
</aside>

<h1 id="rest-api-payments">REST API payments</h1>

<h2 id="requestid">Генерация requestId</h2>
<pre class="highlight php"><code>function gen_auth($merchantId, $secret)
{
        $reqid = time() ."_". microtime(true) ."_". rand();
        $hash = hash("sha256", $merchantId ."-". $reqid ."-". $secret);
        return $merchantId ."-".$hash ."-". $reqid;
}
</code></pre>
<pre class="highlight csharp"><code><span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">GenerateXAuth</span><span class="p">(</span><span class="kt">string</span> <span class="n">secret</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">var</span> <span class="n">requestId</span> <span class="p">=</span> <span class="n">Guid</span><span class="p">.</span><span class="nf">NewGuid</span><span class="p">().</span><span class="nf">ToString</span><span class="p">(</span><span class="s">"N"</span><span class="p">);</span>
    <span class="kt">string</span> <span class="n">hash</span><span class="p">;</span>
    <span class="k">using</span> <span class="p">(</span><span class="n">var</span> <span class="n">sha256</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">Cryptography</span><span class="p">.</span><span class="n">SHA256</span><span class="p">.</span><span class="nf">Create</span><span class="p">())</span>
        <span class="n">hash</span> <span class="p">=</span> <span class="n">BitConverter</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(</span><span class="n">sha256</span><span class="p">.</span><span class="nf">ComputeHash</span><span class="p">(</span><span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="err">$</span><span class="s">"{merchantId}-{requestId}-{secret}"</span><span class="p">))).</span><span class="nf">ToLower</span><span class="p">().</span><span class="nf">Replace</span><span class="p">(</span><span class="s">"-"</span><span class="p">,</span> <span class="s">""</span><span class="p">);</span>
    <span class="k">return</span> <span class="err">$</span><span class="s">"{merchantId}-{hash}-{requestId}"</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>

<p>Все запросы должны быть с заголовком <code class="prettyprint">Content-Type: application/json</code>
Аутентикация запросов происходит посредством заголовка <code class="prettyprint">X-Auth</code> следующего содержания:
<code class="prettyprint">merchantId-SHA256(merchantId-requestId-secret)-requestId</code></p>

<p><code class="prettyprint">requestId</code> - уникальный номер запроса, представляющий из себя текущий таймстамп в миллисекундах, либо набор байт, сгенерированный криптографически-надёжным генератором случайных числел.</p>

<h2 id="transaction-types">Transaction types</h2>

<p>Типы транзакций и их описание/назначение представлены в таблице</p>

<table><thead>
<tr>
<th>Тип транзакции</th>
<th>Описание</th>
</tr>
</thead><tbody>
<tr>
<td>pay</td>
<td>списание денег с карты (purchase)</td>
</tr>
<tr>
<td>payout</td>
<td>зачисление денег на карту(moneysend)</td>
</tr>
<tr>
<td>preauth</td>
<td>блокировка суммы на карте (предавторизация суммы)</td>
</tr>
<tr>
<td>confirmauth</td>
<td>подтверждение списания заблокированной (предавторизованной) суммы</td>
</tr>
<tr>
<td>reversal</td>
<td>возврат заблокированной (предавторизованной суммы)</td>
</tr>
<tr>
<td>refund</td>
<td>отмена операции покупки</td>
</tr>
<tr>
<td>rebill</td>
<td>повторное (автоматическое) списание на основании ранее совершенной транзакции <code class="prettyprint">pay</code></td>
</tr>
</tbody></table>

<p>Для совершения вышеуказанных транзакций необходимо отправить <code class="prettyprint">POST</code> запрос на <code class="prettyprint">https://secure.mandarinpay.com/api/transactions</code></p>

<p>Все транзакции осуществляются в асинхронном режиме, переход пользователя обратно на ваш сайт не означает окончательного выполнения транзакции, необходимо ожидать получения callback-вызова.</p>

<h2 id="card-pay-payout">- Card pay / payout</h2>

<blockquote>
<p>Создание транзакции по непривязанной карте</p>
</blockquote>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"payment"</span><span class="p">:</span><span class="w">
  </span><span class="p">{</span><span class="w">
      </span><span class="nt">"orderId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"123321"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"pay/payout"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"10"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nt">"customerInfo"</span><span class="p">:</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nt">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user@example.com"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"phone"</span><span class="p">:</span><span class="w"> </span><span class="s2">"+79001234567"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nt">"customValues"</span><span class="p">:</span><span class="w">
  </span><span class="p">[</span><span class="w">
     </span><span class="p">{</span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"custom field 0"</span><span class="p">,</span><span class="w"> </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"123321"</span><span class="p">},</span><span class="w">
     </span><span class="p">{</span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"custom field 1"</span><span class="p">,</span><span class="w"> </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"123321"</span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<pre class="highlight html"><code>Standard HTTP 200 JSON response:
</code></pre>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"43913ddc000c4d3990fddbd3980c1725"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"userWebLink"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://secure.mandarinpay.com/Pay?transaction=0eb51e74-e704-4c36-b5cb-8f0227621518"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<pre class="highlight html"><code>Standard HTTP 400 Bad request:
</code></pre>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"error"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Invalid request"</span><span class="w">

</span><span class="p">}</span><span class="w">
</span></code></pre>

<blockquote>
<p>Создание транзакции по привязанной карте</p>
</blockquote>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"payment"</span><span class="p">:</span><span class="w">
  </span><span class="p">{</span><span class="w">
      </span><span class="nt">"orderId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"123321"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"pay/payout"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"10"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nt">"target"</span><span class="p">:</span><span class="w">
  </span><span class="p">{</span><span class="w">
      </span><span class="nt">"card"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0eb51e74-e704-4c36-b5cb-8f0227621518"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<pre class="highlight html"><code>Standard HTTP 200 JSON response:
</code></pre>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"43913ddc000c4d3990fddbd3980c1725"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<pre class="highlight html"><code>Standard HTTP 400 Bad request:
</code></pre>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"error"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Invalid request"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p><code class="prettyprint">POST</code> на <code class="prettyprint">https://secure.mandarinpay.com/api/transactions</code></p>

<p>В поле <code class="prettyprint">action</code> допустимы значения:</p>

<table><thead>
<tr>
<th>Значение</th>
<th>Описание</th>
</tr>
</thead><tbody>
<tr>
<td>pay</td>
<td>списание денег с карты</td>
</tr>
<tr>
<td>payout</td>
<td>зачисление денег на карту</td>
</tr>
</tbody></table>

<h3 id="no-binding-transaction">Создание транзакции по непривязанной карте (no-binding transaction)</h3>

<p>Для совершения транзакции необходимо перенаправить пользователя на url, полученный в поле <code class="prettyprint">userWebLink</code>. </p>

<h3 id="binding-transaction">Создание транзакции по привязанной карте (binding transaction)</h3>

<p>Используйте <code class="prettyprint">Id</code> привязки в качестве значения для <code class="prettyprint">target</code>-&gt;<code class="prettyprint">preauth/reversal</code></p>

<h2 id="preauth">- Preauth</h2>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"payment"</span><span class="p">:</span><span class="w">
  </span><span class="p">{</span><span class="w">
      </span><span class="nt">"orderId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"123321"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"preauth"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"10"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nt">"customerInfo"</span><span class="p">:</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nt">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user@example.com"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"phone"</span><span class="p">:</span><span class="w"> </span><span class="s2">"+79001234567"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nt">"customValues"</span><span class="p">:</span><span class="w">
  </span><span class="p">[</span><span class="w">
   </span><span class="p">{</span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"custom field 0"</span><span class="p">,</span><span class="w"> </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"123321"</span><span class="p">},</span><span class="w">
   </span><span class="p">{</span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"custom field 1"</span><span class="p">,</span><span class="w"> </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"123321"</span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<pre class="highlight html"><code>Standard HTTP 200 JSON response:
</code></pre>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"43913ddc000c4d3990fddbd3980c1725"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"userWebLink"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://secure.mandarinpay.com/Pay?transaction=0eb51e74-e704-4c36-b5cb-8f0227621518"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<pre class="highlight html"><code>Standard HTTP 400 Bad request:
</code></pre>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"error"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Invalid request"</span><span class="w">

</span><span class="p">}</span><span class="w">
</span></code></pre>

<p><code class="prettyprint">POST</code> на <code class="prettyprint">https://secure.mandarinpay.com/api/transactions</code></p>

<p>Предавторизация производится аналогично обычной покупке как через API платежной страницы, так и через REST API. Необходимо в поле <code class="prettyprint">action</code> передать значение <code class="prettyprint">preauth</code>. </p>

<p>После того как придёт уведомление об успехе предавторизации полученый в нём Id транзакции можно использовать для полного или частичного списания, а также разблокировки денежных средств через REST API, используя этот номер в качестве значения для <code class="prettyprint">target</code>-&gt;<code class="prettyprint">preauth/reversal</code> (см. ниже)</p>

<h2 id="confirmauth">- ConfirmAuth</h2>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"payment"</span><span class="p">:</span><span class="w">
  </span><span class="p">{</span><span class="w">
      </span><span class="nt">"orderId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"123321"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"pay"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"10"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nt">"target"</span><span class="p">:</span><span class="w">
  </span><span class="p">{</span><span class="w">
      </span><span class="nt">"preauth"</span><span class="p">:</span><span class="w"> </span><span class="s2">"43913ddc000c4d3990fddbd3980c1725"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<pre class="highlight html"><code>Standard HTTP 200 JSON response:
</code></pre>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"43913ddc000c4d3990fddbd3980c1725"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<pre class="highlight html"><code>Standard HTTP 400 Bad request:
</code></pre>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"error"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Invalid request"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p><code class="prettyprint">POST</code> на <code class="prettyprint">https://secure.mandarinpay.com/api/transactions</code></p>

<p>Для полного или частичного списания используйте полученный в уведомлении об успешной предавторизации <code class="prettyprint">Id</code> в качестве значения для <code class="prettyprint">target</code>-&gt;<code class="prettyprint">preauth</code>:</p>

<h2 id="reversal">- Reversal</h2>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"payment"</span><span class="p">:</span><span class="w">
  </span><span class="p">{</span><span class="w">
      </span><span class="nt">"orderId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"123321"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"reversal"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nt">"target"</span><span class="p">:</span><span class="w">
  </span><span class="p">{</span><span class="w">
      </span><span class="nt">"preauth"</span><span class="p">:</span><span class="w"> </span><span class="s2">"43913ddc000c4d3990fddbd3980c1725"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p><code class="prettyprint">POST</code> на <code class="prettyprint">https://secure.mandarinpay.com/api/transactions</code></p>

<p>Для разблокировки средств используйте полученный в уведомлении об успешной предавторизации <code class="prettyprint">Id</code> в качестве значения для <code class="prettyprint">target</code>-&gt;<code class="prettyprint">reversal</code>:</p>

<h2 id="refund">- Refund</h2>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"payment"</span><span class="p">:</span><span class="w">
  </span><span class="p">{</span><span class="w">
      </span><span class="nt">"orderId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"123321"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"reversal"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nt">"target"</span><span class="p">:</span><span class="w">
  </span><span class="p">{</span><span class="w">
      </span><span class="nt">"transaction"</span><span class="p">:</span><span class="w"> </span><span class="s2">"43913ddc000c4d3990fddbd3980c1725"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<pre class="highlight html"><code>Standard HTTP 200 JSON response:
</code></pre>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"43913ddc000c4d3990fddbd3980c1725"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p><code class="prettyprint">POST</code> на <code class="prettyprint">https://secure.mandarinpay.com/api/transactions</code></p>

<p>В поле <code class="prettyprint">reversal</code> необходимо указать Id ранее проведённой успешной транзакции на списание средств с карты (<code class="prettyprint">pay</code>)</p>

<h2 id="rebill">- Rebill</h2>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"payment"</span><span class="p">:</span><span class="w">
  </span><span class="p">{</span><span class="w">
      </span><span class="nt">"orderId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"123321"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"pay"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"10"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nt">"target"</span><span class="p">:</span><span class="w">
  </span><span class="p">{</span><span class="w">
      </span><span class="nt">"rebill"</span><span class="p">:</span><span class="w"> </span><span class="s2">"43913ddc000c4d3990fddbd3980c1725"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<pre class="highlight html"><code>Standard HTTP 200 JSON response:
</code></pre>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"43913ddc000c4d3990fddbd3980c1725"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<pre class="highlight html"><code>Standard HTTP 400 Bad request:
</code></pre>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"error"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Invalid request"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p><code class="prettyprint">POST</code> на <code class="prettyprint">https://secure.mandarinpay.com/api/transactions</code></p>

<p>В поле <code class="prettyprint">rebill</code> необходимо указать Id ранее проведённой успешной транзакции на списание средств с карты (<code class="prettyprint">pay</code>)</p>

<h2 id="other">Прочие вызовы (other)</h2>

<p>Типы транзакций и их описание/назначение представлены в таблице</p>

<table><thead>
<tr>
<th>Тип транзакции</th>
<th>Описание</th>
</tr>
</thead><tbody>
<tr>
<td>knownCardNumber</td>
<td>пзачисление денег на известный номер карты</td>
</tr>
<tr>
<td>phone</td>
<td>зачисление денег на номер мобильного телефона</td>
</tr>
<tr>
<td>bestmt</td>
<td>перевод денег в систему денежных переводов БЭСТ / Unistream</td>
</tr>
</tbody></table>

<p>Для совершения вышеуказанных транзакций необходимо отправить <code class="prettyprint">POST</code> запрос на <code class="prettyprint">https://secure.mandarinpay.com/api/transactions</code></p>

<p>Все транзакции осуществляются в асинхронном режиме, переход пользователя обратно на ваш сайт не означает окончательного выполнения транзакции, необходимо ожидать получения callback-вызова.</p>

<h2 id="knowncardnumber">- knownCardNumber</h2>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"payment"</span><span class="p">:</span><span class="w">
  </span><span class="p">{</span><span class="w">
      </span><span class="nt">"orderId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"123321"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"payout"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"10"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nt">"customerInfo"</span><span class="p">:</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nt">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user@example.com"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"phone"</span><span class="p">:</span><span class="w"> </span><span class="s2">"+79001234567"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nt">"target"</span><span class="p">:</span><span class="w">
  </span><span class="p">{</span><span class="w">
      </span><span class="nt">"knownCardNumber"</span><span class="p">:</span><span class="w"> </span><span class="s2">"4012888888881881"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<pre class="highlight html"><code>Standard HTTP 200 JSON response:
</code></pre>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"43913ddc000c4d3990fddbd3980c1725"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<pre class="highlight html"><code>Standard HTTP 400 Bad request:
</code></pre>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"error"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Invalid request"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p><code class="prettyprint">POST</code> на <code class="prettyprint">https://secure.mandarinpay.com/api/transactions</code></p>

<p>Транзакция будет совершена в асинхронном режиме, ожидайте получение callback-вызова</p>

<h2 id="phone">- Phone</h2>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"payment"</span><span class="p">:</span><span class="w">
  </span><span class="p">{</span><span class="w">
      </span><span class="nt">"orderId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"123321"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"payout"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"10"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nt">"customerInfo"</span><span class="p">:</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nt">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user@example.com"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"phone"</span><span class="p">:</span><span class="w"> </span><span class="s2">"+79001234567"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nt">"target"</span><span class="p">:</span><span class="w"> </span><span class="s2">"phone"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<pre class="highlight html"><code>Standard HTTP 200 JSON response:
</code></pre>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"43913ddc000c4d3990fddbd3980c1725"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<pre class="highlight html"><code>Standard HTTP 400 Bad request:
</code></pre>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"error"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Invalid request"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p><code class="prettyprint">POST</code> на <code class="prettyprint">https://secure.mandarinpay.com/api/transactions</code></p>

<p>Транзакция будет совершена в асинхронном режиме, ожидайте получение callback-вызова</p>

<h2 id="bestmt">- Bestmt</h2>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"payment"</span><span class="p">:</span><span class="w">
  </span><span class="p">{</span><span class="w">
      </span><span class="nt">"orderId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"123321"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"payout"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"10"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nt">"customerInfo"</span><span class="p">:</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nt">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user@example.com"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"phone"</span><span class="p">:</span><span class="w"> </span><span class="s2">"+79001234567"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"firstName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Василий"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"middleName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Иванович"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"lastName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Пупкин"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"document"</span><span class="p">:</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nt">"rfnspDocId"</span><span class="p">:</span><span class="w"> </span><span class="mi">21</span><span class="p">,</span><span class="w">
        </span><span class="nt">"docSeria"</span><span class="p">:</span><span class="w"> </span><span class="s2">"7709"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"docNum"</span><span class="p">:</span><span class="w"> </span><span class="s2">"543987"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"docIssuer"</span><span class="p">:</span><span class="w">  </span><span class="s2">"УПРАВЛЕНИЕ ФЕДЕРАЛЬНОЙ МИГРАЦИОННОЙ СЛУЖБЫ РОССИИ ПО ГОР.МОСКВЕ"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"docIssuerCode"</span><span class="p">:</span><span class="w"> </span><span class="s2">"770-001"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"docIssuingDate"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2011-01-01"</span><span class="p">,</span><span class="w">
    </span><span class="err">}</span><span class="p">,</span><span class="w">
    </span><span class="nt">"birthDate"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1980-01-01"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"birthPlace"</span><span class="p">:</span><span class="w"> </span><span class="s2">"г. Москва"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"countryCode"</span><span class="p">:</span><span class="w"> </span><span class="s2">"643"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"taxInfo"</span><span class="p">:</span><span class="w">
    </span><span class="p">{</span><span class="w">
          </span><span class="nt">"isRussianFederationTaxResident"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nt">"target"</span><span class="p">:</span><span class="w"> </span><span class="s2">"bestmt"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p><code class="prettyprint">POST</code> на <code class="prettyprint">https://secure.mandarinpay.com/api/transactions</code></p>

<p>Транзакция будет совершена в асинхронном режиме, ожидайте получение callback-вызова</p>

<h1 id="rest-api-bindings">REST API bindings</h1>

<h2 id="requestid">Генерация requestId</h2>

<p>Смотри <a href="#requestid">Генерация requestId</a> из REST API payments</p>

<h2 id="binding-types">Binding types</h2>

<p>Привязка карты (binding) используется для целей списания/зачисления на карту без участия пользователя, а также для проверки того, что пользователь имеет доступ к данной карте (списание контрольной суммы, проверка через 3DS)</p>

<p>Типы привязок и их краткое описание представлены в таблице</p>

<table><thead>
<tr>
<th>Тип привязок</th>
<th>Описание</th>
</tr>
</thead><tbody>
<tr>
<td>card-binding</td>
<td>Полноценная привязка карты</td>
</tr>
<tr>
<td>one-side-binding</td>
<td>одностороння привязка карты</td>
</tr>
</tbody></table>

<p>Для совершения вышеуказанных транзакций необходимо отправить <code class="prettyprint">POST</code> запрос на <code class="prettyprint">https://secure.mandarinpay.com/api/card-bindings</code></p>

<p>Все транзакции осуществляются в асинхронном режиме, переход пользователя обратно на ваш сайт не означает окончательного выполнения транзакции, необходимо ожидать получения callback-вызова.</p>

<h2 id="card-binding">- Card-binding</h2>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
    </span><span class="nt">"customerInfo"</span><span class="p">:</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nt">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user@example.com"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"phone"</span><span class="p">:</span><span class="w"> </span><span class="s2">"+79001234567"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<pre class="highlight html"><code>Standard HTTP 200 JSON response:
</code></pre>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
    </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0eb51e74-e704-4c36-b5cb-8f0227621518"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"userWebLink"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://secure.mandarinpay.com/CardBindings/New?id=0eb51e74-e704-4c36-b5cb-8f0227621518"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p><code class="prettyprint">POST</code> на <code class="prettyprint">https://secure.mandarinpay.com/api/card-bindings</code></p>

<p>Данный вызов можно использовать в следующих целях:</p>

<ul>
<li><p>&ldquo;сохранение данных карты&rdquo; - чтобы пользователь при следующих оплатах не вводил данные карточки, а выбирал привязанную карту из списка</p></li>
<li><p>автосписание - возможность впоследствии сделать автосписание с карты</p></li>
<li><p>зачисление денежных средств на карту</p></li>
</ul>

<p>Полученный <code class="prettyprint">id</code> следует сохранить, а пользователя перенаправить по ссылке, полученной в поле <code class="prettyprint">userWebLink</code>. </p>

<p>Привязанную карту можно будет использовать после получения callback-уведомления об её успешной привязке.</p>

<h2 id="one-side-binding">- One-side-binding</h2>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
    </span><span class="nt">"customerInfo"</span><span class="p">:</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nt">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user@example.com"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"phone"</span><span class="p">:</span><span class="w"> </span><span class="s2">"+79001234567"</span><span class="w">
    </span><span class="p">},</span><span class="w">
  </span><span class="nt">"target"</span><span class="p">:</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nt">"knownCardNumber"</span><span class="p">:</span><span class="w"> </span><span class="s2">"4012888888881881"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<pre class="highlight html"><code>Standard HTTP 200 JSON response:
</code></pre>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
    </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0eb51e74-e704-4c36-b5cb-8f0227621518"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p><code class="prettyprint">POST</code> на <code class="prettyprint">https://secure.mandarinpay.com/api/card-bindings</code></p>

<p>Данный вызов по сути представляет из себя токенизацию известного номера карты и используется для того, чтобы не хранить в вашей системе номер карты.</p>

<p>В отличие от предыдущего вызова, такая привязка может быть использована <strong>исключительно для зачисления</strong> (<code class="prettyprint">action=payout</code>) денежных средств на карту.</p>

<h1 id="callback">Callback-уведомления</h1>

<blockquote>
<p>Пример проверки <code class="prettyprint">sign</code></p>
</blockquote>
<pre class="highlight php"><code>function check_sign($secret, $req)
{
        $sign = $req['sign'];
        unset($req['sign']);
        $to_hash = '';
        if (!is_null($req) <span class="err">&amp;&amp;</span> is_array($req)) {
                ksort($req);
                $to_hash = implode('-', $req);
        }

        $to_hash = $to_hash .'-'. $secret;
        $calculated_sign = hash('sha256', $to_hash);
        return $calculated_sign == $sign;
}

check_sign("123", $_POST);

</code></pre>
<pre class="highlight csharp"><code><span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">Calculate</span><span class="p">(</span><span class="kt">string</span> <span class="n">secret</span><span class="p">,</span> <span class="n">IDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;</span> <span class="n">values</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">using</span> <span class="p">(</span><span class="n">var</span> <span class="n">sha256</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">Cryptography</span><span class="p">.</span><span class="n">SHA256</span><span class="p">.</span><span class="nf">Create</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">BitConverter</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(</span><span class="n">sha256</span><span class="p">.</span><span class="nf">ComputeHash</span><span class="p">(</span><span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="s">"-"</span><span class="p">,</span> <span class="n">values</span><span class="p">.</span><span class="nf">OrderBy</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Key</span><span class="p">,</span> <span class="n">StringComparer</span><span class="p">.</span><span class="n">Ordinal</span><span class="p">).</span><span class="nf">Select</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Value</span><span class="p">))</span> <span class="p">+</span> <span class="s">"-"</span> <span class="p">+</span> <span class="n">secret</span><span class="p">))).</span><span class="nf">ToLower</span><span class="p">().</span><span class="nf">Replace</span><span class="p">(</span><span class="s">"-"</span><span class="p">,</span> <span class="s">""</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">CheckSign</span><span class="p">(</span><span class="kt">string</span> <span class="n">secret</span><span class="p">,</span> <span class="n">HttpRequest</span> <span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">var</span> <span class="n">sign</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="n">Form</span><span class="p">[</span><span class="s">"sign"</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrWhiteSpace</span><span class="p">(</span><span class="n">sign</span><span class="p">))</span>
      <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">sign</span> <span class="p">==</span>
        <span class="nf">Calculate</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">Form</span><span class="p">.</span><span class="n">Keys</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">k</span> <span class="p">=&gt;</span> <span class="n">k</span> <span class="p">!=</span> <span class="s">"sign"</span><span class="p">).</span><span class="nf">ToDictionary</span><span class="p">(</span><span class="n">k</span> <span class="p">=&gt;</span> <span class="n">k</span><span class="p">,</span> <span class="n">k</span> <span class="p">=&gt;</span> <span class="n">request</span><span class="p">.</span><span class="n">Form</span><span class="p">[</span><span class="n">k</span><span class="p">]));</span>
<span class="p">}</span>

</code></pre>

<p>Уведомления высылаются на указанный в клиентском интерфейсе <code class="prettyprint">CallbackUrl</code> в теле POST-запроса с <code class="prettyprint">Content-Type: application/x-www-urlencoded</code>. </p>

<p>В качестве ответа обработчик должен вернуть HTTP-код <code class="prettyprint">200</code> и тело ответа <code class="prettyprint">OK</code>.</p>

<p>Для подтверждения того, что уведомление пришло именно от системы MandarinPay необходимо проверять значение поля <code class="prettyprint">sign</code>, являющегося SHA256-суммой от значений всех параметров запроса, отсортированных алфавитно по именам и <code class="prettyprint">SharedSec</code>, разделённых символом <code class="prettyprint">-</code>.</p>

<p>В зависимости от значения <code class="prettyprint">object_type</code> уведомления бывают следующих видов:</p>

<table><thead>
<tr>
<th>Тип</th>
<th>Описание</th>
</tr>
</thead><tbody>
<tr>
<td><code class="prettyprint">card_binding</code></td>
<td>привязка карты</td>
</tr>
<tr>
<td><code class="prettyprint">transaction</code></td>
<td>транзакция</td>
</tr>
</tbody></table>

<h2 id="card_binding-callback">Card_binding callback</h2>

<table><thead>
<tr>
<th>Поле</th>
<th>Пример</th>
<th>Описание</th>
</tr>
</thead><tbody>
<tr>
<td><code class="prettyprint">card_binding</code></td>
<td><code class="prettyprint">38467cb0-da73-4755-84da-2acb7f638a59</code></td>
<td>Идентификационный номер привязки</td>
</tr>
<tr>
<td><code class="prettyprint">card_holder</code></td>
<td><code class="prettyprint">VASILY PUPKIN</code></td>
<td>Держатель карты</td>
</tr>
<tr>
<td><code class="prettyprint">card_number</code></td>
<td><code class="prettyprint">123456XXXXXX7890</code></td>
<td>Номер карты</td>
</tr>
<tr>
<td><code class="prettyprint">card_expiration_year</code></td>
<td><code class="prettyprint">18</code></td>
<td>Год срока действия карты</td>
</tr>
<tr>
<td><code class="prettyprint">card_expiration_month</code></td>
<td><code class="prettyprint">9</code></td>
<td>Месяц срока действия карты</td>
</tr>
<tr>
<td><code class="prettyprint">status</code></td>
<td><code class="prettyprint">success</code></td>
<td>Статус привязки</td>
</tr>
</tbody></table>

<h2 id="transaction-callback">Transaction callback</h2>

<table><thead>
<tr>
<th>Поле</th>
<th>Пример</th>
<th>Описание</th>
</tr>
</thead><tbody>
<tr>
<td><code class="prettyprint">transaction</code></td>
<td><code class="prettyprint">05991602ed7c47d996ca7ab119b07f66</code></td>
<td>ID транзакции в системе</td>
</tr>
<tr>
<td><code class="prettyprint">status</code></td>
<td><code class="prettyprint">success</code>, <code class="prettyprint">failed</code></td>
<td>Статус операции</td>
</tr>
<tr>
<td><code class="prettyprint">action</code></td>
<td><code class="prettyprint">pay</code>, <code class="prettyprint">payout</code></td>
<td>Действие (покупка или выплата на карту)</td>
</tr>
<tr>
<td><code class="prettyprint">merchantId</code></td>
<td><code class="prettyprint">42</code></td>
<td>Id мерчанта</td>
</tr>
<tr>
<td><code class="prettyprint">price</code></td>
<td><code class="prettyprint">12.34</code></td>
<td>Сумма платежа. Обязательна к передаче в текущей версии системы.</td>
</tr>
<tr>
<td><code class="prettyprint">orderId</code></td>
<td><code class="prettyprint">1234OR</code></td>
<td>Уникальный номер заказа в системе Продавца.</td>
</tr>
<tr>
<td><code class="prettyprint">customer_email</code></td>
<td><code class="prettyprint">user@example.com</code></td>
<td>Email пользователя</td>
</tr>
<tr>
<td><code class="prettyprint">customer_phone</code></td>
<td><code class="prettyprint">+71234567890</code></td>
<td>Телефон пользователя</td>
</tr>
</tbody></table>

<h1 id="xml-api-mandarininfo">XML API MandarinInfo (УИ)</h1>

<p>Данный протокол используется для проведения упрощенной идентифкации в соответствии с требованиями ФЗ№ 115-ФЗ</p>

<p>Документация расположена по <a href="https://mandarinpay.com/sites/default/files/XML_API_MandarinInfo.pdf">адресу</a></p>

      </div>
      <div class="dark-box">
          <div class="lang-selector">
                <a href="#" data-language-name="php">PHP</a>
                <a href="#" data-language-name="cs">C#</a>
          </div>
      </div>
    </div>
  </body>
</html>
